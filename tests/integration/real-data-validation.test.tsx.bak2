import { describe, it, expect, beforeEach, afterEach, vi } from "vitest";
import { render, screen, waitFor } from "@testing-library/react";
import React from "react";
import { TimeTableGrid } from "@/components/organisms/TimeTableGrid";
import { SessionBlock } from "@/components/molecules/SessionBlock";
import { StudentPanel } from "@/components/organisms/StudentPanel";

// ë„¤íŠ¸ì›Œí¬ ë¶ˆì•ˆì • ìƒí™© ì‹œë®¬ë ˆì´ì…˜
describe("ë„¤íŠ¸ì›Œí¬ ë¶ˆì•ˆì • ìƒí™© í…ŒìŠ¤íŠ¸", () => {
  beforeEach(() => {
    // ë„¤íŠ¸ì›Œí¬ ìš”ì²­ ëª¨í‚¹
    global.fetch = vi.fn();
  });

  afterEach(() => {
    vi.restoreAllMocks();
  });

  it("ë„¤íŠ¸ì›Œí¬ íƒ€ì„ì•„ì›ƒ ìƒí™©ì—ì„œ ì»´í¬ë„ŒíŠ¸ê°€ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬ë˜ì–´ì•¼ í•œë‹¤", async () => {
    // Arrange - ë„¤íŠ¸ì›Œí¬ íƒ€ì„ì•„ì›ƒ ì‹œë®¬ë ˆì´ì…˜
    vi.mocked(global.fetch).mockImplementation(
      () =>
        new Promise((_, reject) =>
          setTimeout(() => reject(new Error("Network timeout")), 100)
        )
    );

    // Act - ì»´í¬ë„ŒíŠ¸ ë Œë”ë§
    render(<TimeTableGrid sessions={new Map()} subjects={[]} />);

    // Assert - ì»´í¬ë„ŒíŠ¸ê°€ í¬ë˜ì‹œí•˜ì§€ ì•Šê³  ë Œë”ë§ë¨
    await waitFor(() => {
      expect(screen.getByTestId("time-table-grid")).toBeInTheDocument();
    });
  });

  it("ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ ìƒí™©ì—ì„œ ê¸°ë³¸ê°’ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬ë˜ì–´ì•¼ í•œë‹¤", async () => {
    // Arrange - ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ ì‹œë®¬ë ˆì´ì…˜
    vi.mocked(global.fetch).mockRejectedValue(new Error("Network error"));

    // Act - SessionBlock ì»´í¬ë„ŒíŠ¸ ë Œë”ë§ (ì˜ëª»ëœ ë°ì´í„°)
    const invalidSession = {
      id: "session-1",
      subjectId: "subject-1",
      startsAt: "10:00",
      endsAt: "11:00",
      weekday: 1,
      enrollmentIds: undefined, // ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ë¡œ ì¸í•œ undefined
    };

    render(
      <SessionBlock
        session={invalidSession}
        subjects={[]}
        students={[]}
        enrollments={[]}
        onClick={() => {}}
      />
    );

    // Assert - ì»´í¬ë„ŒíŠ¸ê°€ ì•ˆì „í•˜ê²Œ ë Œë”ë§ë¨
    expect(screen.getByTestId("session-block-session-1")).toBeInTheDocument();
  });

  it("ëŠë¦° ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì—ì„œ ë¡œë”© ìƒíƒœê°€ ì ì ˆíˆ í‘œì‹œë˜ì–´ì•¼ í•œë‹¤", async () => {
    // Arrange - ëŠë¦° ë„¤íŠ¸ì›Œí¬ ì‹œë®¬ë ˆì´ì…˜
    vi.mocked(global.fetch).mockImplementation(
      () =>
        new Promise((resolve) =>
          setTimeout(() => resolve(new Response("{}")), 2000)
        )
    );

    // Act - StudentPanel ì»´í¬ë„ŒíŠ¸ ë Œë”ë§
    const mockPanelState = {
      position: { x: 0, y: 0 },
      filteredStudents: [],
      searchQuery: "",
    };

    render(
      <StudentPanel
        panelState={mockPanelState}
        onSearchChange={() => {}}
        onStudentSelect={() => {}}
        onDragStart={() => {}}
        onDragEnd={() => {}}
      />
    );

    // Assert - ì»´í¬ë„ŒíŠ¸ê°€ ì¦‰ì‹œ ë Œë”ë§ë¨
    expect(screen.getByTestId("students-panel-header")).toBeInTheDocument();
  });
});

// ì‹¤ì œ ë°ì´í„° í˜•ì‹ ê²€ì¦ í…ŒìŠ¤íŠ¸
describe("ì‹¤ì œ ë°ì´í„° í˜•ì‹ ê²€ì¦ í…ŒìŠ¤íŠ¸", () => {
  it("APIì—ì„œ ë°›ì€ ì‹¤ì œ ë°ì´í„° í˜•ì‹ì´ ì˜ˆìƒê³¼ ë‹¤ë¥¼ ë•Œ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬ë˜ì–´ì•¼ í•œë‹¤", () => {
    // Arrange - ì‹¤ì œ APIì—ì„œ ë°›ì„ ìˆ˜ ìˆëŠ” ë‹¤ì–‘í•œ ë°ì´í„° í˜•ì‹
    const realWorldData = {
      // ì •ìƒì ì¸ ë°ì´í„°
      normalSession: {
        id: "session-1",
        subjectId: "subject-1",
        startsAt: "10:00",
        endsAt: "11:00",
        weekday: 1,
        enrollmentIds: ["enrollment-1"],
      },
      // enrollmentIdsê°€ nullì¸ ê²½ìš°
      nullEnrollmentIds: {
        id: "session-2",
        subjectId: "subject-1",
        startsAt: "11:00",
        endsAt: "12:00",
        weekday: 1,
        enrollmentIds: null,
      },
      // enrollmentIdsê°€ ë¹ˆ ë°°ì—´ì¸ ê²½ìš°
      emptyEnrollmentIds: {
        id: "session-3",
        subjectId: "subject-1",
        startsAt: "12:00",
        endsAt: "13:00",
        weekday: 1,
        enrollmentIds: [],
      },
      // enrollmentIdsê°€ undefinedì¸ ê²½ìš°
      undefinedEnrollmentIds: {
        id: "session-4",
        subjectId: "subject-1",
        startsAt: "13:00",
        endsAt: "14:00",
        weekday: 1,
        enrollmentIds: undefined,
      },
      // ì˜ëª»ëœ ì‹œê°„ í˜•ì‹
      invalidTimeFormat: {
        id: "session-5",
        subjectId: "subject-1",
        startsAt: "25:70", // ì˜ëª»ëœ ì‹œê°„
        endsAt: "abc", // ì˜ëª»ëœ ì‹œê°„
        weekday: 1,
        enrollmentIds: ["enrollment-1"],
      },
    };

    // Act & Assert - ê° ë°ì´í„° í˜•ì‹ì— ëŒ€í•´ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬ë˜ëŠ”ì§€ í™•ì¸
    Object.entries(realWorldData).forEach(([key, session]) => {
      const { container } = render(
        <SessionBlock
          session={session}
          subjects={[]}
          students={[]}
          enrollments={[]}
          onClick={() => {}}
        />
      );

      // ì»´í¬ë„ŒíŠ¸ê°€ í¬ë˜ì‹œí•˜ì§€ ì•Šê³  ë Œë”ë§ë˜ëŠ”ì§€ í™•ì¸
      expect(container.firstChild).toBeInTheDocument();
      console.log(`${key} ë°ì´í„° í˜•ì‹ì´ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    });
  });

  it("ì‹¤ì œ Supabaseì—ì„œ ë°›ì€ ë³µì¡í•œ JSONB ë°ì´í„°ë¥¼ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬í•´ì•¼ í•œë‹¤", () => {
    // Arrange - ì‹¤ì œ Supabase JSONB ë°ì´í„° êµ¬ì¡°
    const realSupabaseData = {
      user_id: "test-user",
      data: {
        students: [
          {
            id: "student-1",
            name: "ê¹€ì² ìˆ˜",
            gender: "male",
            createdAt: "2024-01-01T00:00:00Z",
            // ì¶”ê°€ í•„ë“œê°€ ìˆì„ ìˆ˜ ìˆìŒ
            extraField: "unexpected",
          },
          {
            id: "student-2",
            name: "ì´ì˜í¬",
            gender: "female",
            createdAt: "2024-01-01T00:00:00Z",
            // ì¼ë¶€ í•„ë“œê°€ ëˆ„ë½ë  ìˆ˜ ìˆìŒ
          },
        ],
        subjects: [
          {
            id: "subject-1",
            name: "ìˆ˜í•™",
            color: "#FF0000",
            createdAt: "2024-01-01T00:00:00Z",
          },
          {
            id: "subject-2",
            name: "ì˜ì–´",
            color: "#00FF00",
            createdAt: "2024-01-01T00:00:00Z",
            // ì˜ˆìƒì¹˜ ëª»í•œ í•„ë“œ
            description: "English subject",
          },
        ],
        sessions: [
          {
            id: "session-1",
            subjectId: "subject-1",
            startsAt: "10:00",
            endsAt: "11:00",
            weekday: 1,
            enrollmentIds: ["enrollment-1"],
            createdAt: "2024-01-01T00:00:00Z",
            // ì˜ˆìƒì¹˜ ëª»í•œ í•„ë“œ
            metadata: { room: "A101" },
          },
        ],
        enrollments: [
          {
            id: "enrollment-1",
            studentId: "student-1",
            subjectId: "subject-1",
            createdAt: "2024-01-01T00:00:00Z",
          },
        ],
        version: "1.0",
        // ì˜ˆìƒì¹˜ ëª»í•œ ìµœìƒìœ„ í•„ë“œ
        settings: {
          theme: "dark",
          language: "ko",
        },
      },
    };

    // Act - ì‹¤ì œ ë°ì´í„°ë¡œ ì»´í¬ë„ŒíŠ¸ ë Œë”ë§
    const { container } = render(
      <TimeTableGrid
        sessions={new Map([["1", [realSupabaseData.data.sessions[0]]]])}
        subjects={realSupabaseData.data.subjects}
      />
    );

    // Assert - ì»´í¬ë„ŒíŠ¸ê°€ ì•ˆì „í•˜ê²Œ ë Œë”ë§ë¨
    expect(container.firstChild).toBeInTheDocument();
    expect(screen.getByTestId("time-table-grid")).toBeInTheDocument();
  });

  it("ì‹¤ì œ ì‚¬ìš©ì ì…ë ¥ ë°ì´í„°ì˜ ë‹¤ì–‘í•œ í˜•ì‹ì„ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬í•´ì•¼ í•œë‹¤", () => {
    // Arrange - ì‚¬ìš©ìê°€ ì…ë ¥í•  ìˆ˜ ìˆëŠ” ë‹¤ì–‘í•œ í˜•ì‹
    const userInputVariations = [
      // ì •ìƒì ì¸ ì…ë ¥
      { name: "ê¹€ì² ìˆ˜", expected: "ê¹€ì² ìˆ˜" },
      // ê³µë°±ì´ í¬í•¨ëœ ì…ë ¥
      { name: " ê¹€ì² ìˆ˜ ", expected: "ê¹€ì² ìˆ˜" },
      // íŠ¹ìˆ˜ë¬¸ìê°€ í¬í•¨ëœ ì…ë ¥
      { name: "ê¹€ì² ìˆ˜@#$%", expected: "ê¹€ì² ìˆ˜@#$%" },
      // ì´ëª¨ì§€ê°€ í¬í•¨ëœ ì…ë ¥
      { name: "ê¹€ì² ìˆ˜ğŸ˜€", expected: "ê¹€ì² ìˆ˜ğŸ˜€" },
      // ë§¤ìš° ê¸´ ì…ë ¥
      { name: "ê¹€ì² ìˆ˜".repeat(100), expected: "ê¹€ì² ìˆ˜".repeat(100) },
      // ìˆ«ìê°€ í¬í•¨ëœ ì…ë ¥
      { name: "ê¹€ì² ìˆ˜123", expected: "ê¹€ì² ìˆ˜123" },
      // HTML íƒœê·¸ê°€ í¬í•¨ëœ ì…ë ¥
      {
        name: "<script>alert('test')</script>ê¹€ì² ìˆ˜",
        expected: "<script>alert('test')</script>ê¹€ì² ìˆ˜",
      },
    ];

    // Act & Assert - ê° ì…ë ¥ í˜•ì‹ì— ëŒ€í•´ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬ë˜ëŠ”ì§€ í™•ì¸
    userInputVariations.forEach(({ name, expected }) => {
      const mockStudent = {
        id: "student-1",
        name: name,
        gender: "male",
      };

      const { container } = render(
        <StudentPanel
          panelState={{
            position: { x: 0, y: 0 },
            filteredStudents: [mockStudent],
            searchQuery: "",
          }}
          onSearchChange={() => {}}
          onStudentSelect={() => {}}
          onDragStart={() => {}}
          onDragEnd={() => {}}
        />
      );

      // ì»´í¬ë„ŒíŠ¸ê°€ í¬ë˜ì‹œí•˜ì§€ ì•Šê³  ë Œë”ë§ë˜ëŠ”ì§€ í™•ì¸
      expect(container.firstChild).toBeInTheDocument();
      console.log(`ì…ë ¥ í˜•ì‹ "${name}"ì´ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    });
  });

  it("ì‹¤ì œ ë¸Œë¼ìš°ì € í™˜ê²½ì—ì„œì˜ ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€ í…ŒìŠ¤íŠ¸", () => {
    // Arrange - ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ë¥¼ ì¼ìœ¼í‚¬ ìˆ˜ ìˆëŠ” ìƒí™©
    const createLargeDataSet = () => {
      return Array.from({ length: 1000 }, (_, i) => ({
        id: `student-${i}`,
        name: `í•™ìƒ${i}`,
        gender: i % 2 === 0 ? "male" : "female",
      }));
    };

    const largeDataSet = createLargeDataSet();

    // Act - ëŒ€ëŸ‰ì˜ ë°ì´í„°ë¡œ ì»´í¬ë„ŒíŠ¸ ë Œë”ë§
    const { container, unmount } = render(
      <StudentPanel
        panelState={{
          position: { x: 0, y: 0 },
          filteredStudents: largeDataSet,
          searchQuery: "",
        }}
        onSearchChange={() => {}}
        onStudentSelect={() => {}}
        onDragStart={() => {}}
        onDragEnd={() => {}}
      />
    );

    // Assert - ì»´í¬ë„ŒíŠ¸ê°€ ë Œë”ë§ë¨
    expect(container.firstChild).toBeInTheDocument();

    // Act - ì»´í¬ë„ŒíŠ¸ ì–¸ë§ˆìš´íŠ¸
    unmount();

    // Assert - ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ê°€ ë°œìƒí•˜ì§€ ì•Šì•˜ëŠ”ì§€ í™•ì¸
    // (ì‹¤ì œë¡œëŠ” ë” ì •êµí•œ ë©”ëª¨ë¦¬ í…ŒìŠ¤íŠ¸ê°€ í•„ìš”í•˜ì§€ë§Œ, ê¸°ë³¸ì ì¸ ì–¸ë§ˆìš´íŠ¸ í…ŒìŠ¤íŠ¸)
    expect(container.firstChild).toBeNull();
  });
});
