#!/bin/bash

# π― PR μƒμ„± μ „ E2E ν…μ¤νΈ λ° ν†µν•© κ²€μ¦ μ¤ν¬λ¦½νΈ
# PR μ „ ν•„μ: μ „μ²΄ ν†µν•© + μ£Όμ” E2E μ‹λ‚λ¦¬μ¤ κ²€μ¦

set -e

echo "π― PR μƒμ„± μ „ E2E λ° ν†µν•© κ²€μ¦ μ‹μ‘..."

# μƒ‰μƒ μ •μ
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m' # No Color

# ν•¨μ: μ„±κ³µ λ©”μ‹μ§€
success() {
    echo -e "${GREEN}β… $1${NC}"
}

# ν•¨μ: κ²½κ³  λ©”μ‹μ§€
warning() {
    echo -e "${YELLOW}β οΈ $1${NC}"
}

# ν•¨μ: μ—λ¬ λ©”μ‹μ§€
error() {
    echo -e "${RED}β $1${NC}"
    exit 1
}

# ν•¨μ: μ •λ³΄ λ©”μ‹μ§€
info() {
    echo -e "${BLUE}β„ΉοΈ $1${NC}"
}

# ν•¨μ: λ‹¨κ³„ λ©”μ‹μ§€
step() {
    echo -e "${PURPLE}π”„ $1${NC}"
}

# μ‹μ‘ μ‹κ°„ κΈ°λ΅
start_time=$(date +%s)

step "1λ‹¨κ³„: μ»¤λ°‹ μ „ κ²€μ¦ μ‹¤ν–‰"
# λ¨Όμ € κΈ°λ³Έ κ²€μ¦ μ‹¤ν–‰
if ! ./scripts/pre-commit-check.sh; then
    error "μ»¤λ°‹ μ „ κΈ°λ³Έ κ²€μ¦μ΄ μ‹¤ν¨ν–μµλ‹λ‹¤. λ¨Όμ € κΈ°λ³Έ λ¬Έμ λ¥Ό ν•΄κ²°ν•μ„Έμ”."
fi
success "κΈ°λ³Έ κ²€μ¦ ν†µκ³Ό"

step "2λ‹¨κ³„: μ „μ²΄ λ‹¨μ„ ν…μ¤νΈ μ‹¤ν–‰"
info "λ¨λ“  λ‹¨μ„ ν…μ¤νΈ μ‹¤ν–‰ μ¤‘..."
if ! npm run test; then
    error "λ‹¨μ„ ν…μ¤νΈκ°€ μ‹¤ν¨ν–μµλ‹λ‹¤."
fi
success "μ „μ²΄ λ‹¨μ„ ν…μ¤νΈ ν†µκ³Ό"

step "3λ‹¨κ³„: μ‹¤μ  Supabase ν†µν•© ν…μ¤νΈ"
info "μ‹¤μ  Supabase μ—°κ²° ν…μ¤νΈ μ‹¤ν–‰ μ¤‘..."
if ! npm run test:integration:real-supabase; then
    warning "Supabase ν†µν•© ν…μ¤νΈκ°€ μ‹¤ν¨ν–μµλ‹λ‹¤. λ„¤νΈμ›ν¬ μ—°κ²°μ„ ν™•μΈν•μ„Έμ”."
    echo "κ³„μ† μ§„ν–‰ν•μ‹κ² μµλ‹κΉ? (y/N): "
    read -r response
    if [[ ! "$response" =~ ^[Yy]$ ]]; then
        error "μ‚¬μ©μκ°€ μ¤‘λ‹¨μ„ μ„ νƒν–μµλ‹λ‹¤."
    fi
else
    success "Supabase ν†µν•© ν…μ¤νΈ ν†µκ³Ό"
fi

step "4λ‹¨κ³„: ν…μ¤νΈ μ»¤λ²„λ¦¬μ§€ ν™•μΈ"
info "ν…μ¤νΈ μ»¤λ²„λ¦¬μ§€ μΈ΅μ • μ¤‘..."
if ! npm run test:coverage; then
    warning "μ»¤λ²„λ¦¬μ§€ μΈ΅μ •μ— μ‹¤ν¨ν–μµλ‹λ‹¤."
else
    success "ν…μ¤νΈ μ»¤λ²„λ¦¬μ§€ μΈ΅μ • μ™„λ£"
fi

# step "5λ‹¨κ³„: μ£Όμ” E2E μ‹λ‚λ¦¬μ¤ ν…μ¤νΈ"
# info "ν•µμ‹¬ μ‚¬μ©μ μ‹λ‚λ¦¬μ¤ E2E ν…μ¤νΈ μ‹¤ν–‰ μ¤‘..."
# if ! npm run test:e2e; then
#     warning "E2E ν…μ¤νΈκ°€ μ‹¤ν¨ν–μµλ‹λ‹¤. λΈλΌμ°μ € ν™κ²½μ„ ν™•μΈν•μ„Έμ”."
#     echo "E2E ν…μ¤νΈ μ‹¤ν¨λ¥Ό λ¬΄μ‹ν•κ³  κ³„μ†ν•μ‹κ² μµλ‹κΉ? (y/N): "
#     read -r response
#     if [[ ! "$response" =~ ^[Yy]$ ]]; then
#         error "E2E ν…μ¤νΈ μ‹¤ν¨λ΅ μΈν• μ¤‘λ‹¨"
#     fi
#     warning "E2E ν…μ¤νΈ μ‹¤ν¨λ¥Ό λ¬΄μ‹ν•κ³  κ³„μ† μ§„ν–‰ν•©λ‹λ‹¤."
# else
#     success "μ£Όμ” E2E μ‹λ‚λ¦¬μ¤ ν…μ¤νΈ ν†µκ³Ό"
# fi
info "β οΈ E2E ν…μ¤νΈλ” ν„μ¬ λ¶μ•μ •μΌλ΅ μΈν•΄ λΉ„ν™μ„±ν™”λ¨ (FUTURE_TODO.md μ°Έμ΅°)"

info "λΈλΌμ°μ € νΈν™μ„± ν…μ¤νΈλ” 5λ‹¨κ³„ E2E ν…μ¤νΈμ— ν¬ν•¨λ¨..."

step "7λ‹¨κ³„: ν”„λ΅λ•μ… λΉλ“ κ²€μ¦"
info "ν”„λ΅λ•μ… λΉλ“ μµμΆ… κ²€μ¦ μ¤‘..."
if ! npm run build; then
    error "ν”„λ΅λ•μ… λΉλ“κ°€ μ‹¤ν¨ν–μµλ‹λ‹¤."
fi
success "ν”„λ΅λ•μ… λΉλ“ κ²€μ¦ ν†µκ³Ό"

step "8λ‹¨κ³„: μ‹μ¤ν… ν†µν•© ν…μ¤νΈ"
info "μ „μ²΄ μ‹μ¤ν… ν†µν•© ν…μ¤νΈ μ‹¤ν–‰ μ¤‘..."
if ! npm run test:system:headless; then
    warning "μ‹μ¤ν… ν†µν•© ν…μ¤νΈκ°€ μ‹¤ν¨ν–μµλ‹λ‹¤."
else
    success "μ‹μ¤ν… ν†µν•© ν…μ¤νΈ ν†µκ³Ό"
fi

# μ‹¤ν–‰ μ‹κ°„ κ³„μ‚°
end_time=$(date +%s)
duration=$((end_time - start_time))

echo ""
echo "π― ========================================="
success "π‰ PR μƒμ„± μ „ κ²€μ¦μ΄ μ™„λ£λμ—μµλ‹λ‹¤!"
echo -e "${PURPLE}β±οΈ  μ΄ μ†μ” μ‹κ°„: ${duration}μ΄${NC}"
echo "π― ========================================="
echo ""
info "β¨ PR μ¤€λΉ„ μ™„λ£: μ „μ²΄ μ‹μ¤ν…μ΄ κ²€μ¦λμ—μµλ‹λ‹¤."
info "π€ μ΄μ  μ•μ „ν•κ² Pull Requestλ¥Ό μƒμ„±ν•  μ μμµλ‹λ‹¤."
info "π“‹ PR μƒμ„± μ‹ λ‹¤μ λ‚΄μ©μ„ ν¬ν•¨ν•μ„Έμ”:"
echo -e "${BLUE}   - λ³€κ²½ μ‚¬ν•­ μ”μ•½${NC}"
echo -e "${BLUE}   - ν…μ¤νΈ κ²°κ³Ό (${duration}μ΄ μ†μ”)${NC}"
echo -e "${BLUE}   - E2E ν…μ¤νΈ ν†µκ³Ό μ—¬λ¶€${NC}"
echo -e "${BLUE}   - λΈλΌμ°μ € νΈν™μ„± ν™•μΈ μ—¬λ¶€${NC}"
